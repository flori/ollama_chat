#!/usr/bin/env ruby

require 'ollama_chat'
require 'tins/go'
include Tins::GO

opts = go 'f:d:rtph', ARGV

# Displays the usage information for the ollama_chat_send command.
#
# This method outputs a formatted help message that describes the available
# options and usage of the ollama_chat_send command, including details about
# sending input to a running Ollama Chat client.
#
# @param rc [ Integer ] the exit code to use when exiting the program
def usage(rc = 0)
  puts <<~EOT
    Usage: #{File.basename($0)} [OPTIONS]

    Options:
      -r         Wait for the response from Ollama Chat and output it
      -t         Send input as terminal input including commands, e. g. /import
      -p         Send input with source parsing enabled (defaults to disabled)
      -f CONFIG  file to read
      -d DIR     the working directory to derive the socket file from
      -h         Show this help message

    Send data to a running Ollame Chat client via standard input.
  EOT
  exit rc
end

config = OllamaChat::OllamaChatConfig.new(opts[?f]).config
opts[?h] and usage
begin
  type = if opts[?t]
           :terminal_input
         else
           opts[?r] ? :socket_input_with_response : :socket_input
         end
  response = OllamaChat::ServerSocket.send_to_server_socket(
    STDIN.read,
    type:,
    config:,
    working_dir: opts[?d],
    parse:       !!opts[?p]
  )
  type == :socket_input_with_response and puts response.content
rescue => e
  warn "Caught #{e.class}: #{e}"
  exit 1
end
exit 0
